# coding:utf-8
from pwn import *
context.log_level = 'debug'

proc_name = 'ciscn_final_5'
libc = ELF('./libc.so.6')
elf = ELF(proc_name)

islocal = 1
if islocal:
    p = process(proc_name)
else:
    p = remote('node4.buuoj.cn', 26809)

def debug(addr, PIE=True):
    if PIE:
        text_base = int(os.popen("pmap {}| awk '{{print $1}}'".format(p.pid)).readlines()[1], 16)
        gdb.attach(p,'b *{}'.format(hex(text_base+addr)))
    else:
        gdb.attach(p,"b *{}".format(hex(addr)))


def add(index, size, content):
    p.recvuntil("your choice: ")
    p.sendline("1")
    p.recvuntil("index: ")
    p.sendline(str(index))
    p.recvuntil("size: ")
    p.sendline(str(size))
    p.recvuntil("content: ")
    p.send(content)
    lowbits = int(p.recvline()[13:18],16)
    log.success("lowbits => " + hex(lowbits))
    return lowbits

def delete(index):
    p.recvuntil("your choice: ")
    p.sendline("2")
    p.recvuntil("index: ")
    p.sendline(str(index))

def edit(index, content):
    p.recvuntil("your choice: ")
    p.sendline("3")
    p.recvuntil("index: ")
    p.sendline(str(index))
    p.recvuntil("content: ")
    p.send(content)


def pwn():
    for i in range(0,17):
        add(i,10,'chunk'+str(i))
    debug(0)
    # edit(0,'joyce')
    # debug(0)
    # delete(0)
    pause()

if __name__ == '__main__':
    pwn()